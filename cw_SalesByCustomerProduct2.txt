

-- 10/31/23 I.R.

-- Customers report corresponds to Sales By Customer & Product Cietrade report



-- [dbo].[cw_SalesByCustomerProduct2] '', '', '', '', '', '', '', 'L', 0, ''



-- [dbo].[cw_SalesByCustomerProduct2] '2023-11-01', '2023-11-13', '', '', '', '', '', 'S', 0, ''



-- [dbo].[cw_SalesByCustomerProduct2] '2023-07-01', '2023-07-31', '', '', '', '', '', 'S', 0, ''



-- [dbo].[cw_SalesByCustomerProduct2] '2023-09-01', '2023-09-30', '', '', '', '', '', 'S', 0, ''





CREATE PROCEDURE [dbo].[cw_SalesByCustomerProduct2] 

	 @FromDate datetime = '',

	 @ToDate datetime = '',

	 @CustID char(12) = '',  

	 @TradeType varchar(48) = '',

	 @CoID varchar(10) = '',

	 @Product varchar(40) = '',

	 @salesRep varchar(40) = '',

	 @UOM char = 'L',

	 @isdrilldown bit = 0,

	 @drilldownCust varchar(100) = ''



--9/23/2022 DN: Created for Sales by Customer & Product Report



AS

SET

NOCOUNT ON

SET

TRANSACTION ISOLATION LEVEL READ UNCOMMITTED



	IF @FromDate =''

	   SET @FromDate = '2023-07-01'

	IF @ToDate = ''

	   SET @ToDate = CAST(GETDATE() AS DATE)



IF OBJECT_ID('tempdb..#detail','U') IS NOT NULL

DROP TABLE #detail



CREATE TABLE #detail(

	CompanyNm varchar(100),

	customerID varchar(100),

	Grade varchar(100),

	shipppingDt datetime,

	Sales money,

	buysellno varchar(20),

	TotalShippedWeight decimal(22,2),

	ShipmentCount int,

	COID char(50),

	WksType char(1)

	,TransactionPeriod varchar(7)

)



INSERT

	#detail

SELECT 

	counterparty.CompanyNm AS [Company Name],

	buysell.CustID AS [Customer ID],

	grade.Description AS Grade,

	buysell.InvoiceDt AS [Shippipng DT],

	wksdetail.SAmount AS [sales],

	buysell.BuySellNo AS BuySellNo,

	isnull(DBO.CONVERT_TO_UOM(WKSDetail.SWeight,WKSDetail.SWeightUOM,@UOM),0) ,

	1,

	CompanyInfo.CompanyDesc,

	CASE WHEN Buysell.custid = '(INV)' THEN 'R' WHEN buysell.vendorid='(INV)' THEN 'S' ELSE 'W' END

	,FORMAT(BuySell.InvoiceDt, 'MM/yyyy') TransactionPeriod



from BuySell

	left join WKSDetail on WKSDetail.BuySellNo = buysell.BuySellNo

	left join CounterParty on buysell.CustID = counterparty.CpID

	left join GPLedger on GPLedger.BuySellNo = buysell.BuySellNo

	left join grade on grade.GradeID = WksDetail.GradeID

	left join CompanyInfo on buysell.COID = CompanyInfo.COID

where

	((GPLedger.Source = 'B' and buysell.status = 'I'))

	AND ((InvoiceDt >=@FromDate) OR (@FromDate = ''))

	AND ((InvoiceDt <=@ToDate) OR (@ToDate = ''))

	and (buysell.CustID = @CustID or @CustID = '')

	AND (@CoID = '' OR (BuySell.CoID = @CoID))

	AND (@TradeType = '' OR @TradeType = BuySell.TradeType)

	AND (@salesRep = '' OR @salesRep= BuySell.ReferrerNo1 OR @salesRep= BuySell.ReferrerNo2)

	and(@Product = '' or grade.GradeID = @Product)



	--01/17/24 I.R.

	--and WksDetail.SFxAmount <> 0



	and (BuySell.CustID <> '(OTHER)' AND  BuySell.CustID <> '(INV)')

	AND (IsNull(IsAgency,0) <> 1)		--worksheets where products dont count on financials.



IF @Product = '' 

BEGIN

	--sales chargebacks

INSERT

	#detail

SELECT

	CounterParty.CompanyNm AS [Company Name],

	buysell.CustID AS [Customer ID],

	'Chargebacks: ' + isnull(glaccount.Name,

	'Other') AS grade,

	buysell.InvoiceDt AS tradeDT,

	WksDelivery.ChgToCustAmt AS sale,

	buysell.BuySellNo AS buyusell,

	0.00,

	0,

	CompanyInfo.CompanyDesc,

	CASE WHEN Buysell.custid = '(INV)' THEN 'R' WHEN buysell.vendorid='(INV)' THEN 'S' ELSE 'W' END

	,FORMAT(BuySell.InvoiceDt, 'M/yyyy') TransactionPeriod

	--,

	--CASE

	--	WHEN TRIM(CAST(MONTH(CAST(BuySell.InvoiceDt AS DATE)) AS VARCHAR)) = 1

	--  THEN '0' + CAST(MONTH(CAST(BuySell.InvoiceDt AS DATE)) AS VARCHAR)+ '/' + CAST(YEAR(CAST(BuySell.InvoiceDt AS DATE)) AS VARCHAR)

	--	ELSE CAST(MONTH(CAST(BuySell.InvoiceDt AS DATE)) AS VARCHAR)+ '/' + CAST(YEAR(CAST(BuySell.InvoiceDt AS DATE)) AS VARCHAR)

	--END TransactionPeriod

from

BuySell

	left join WksDelivery on wksdelivery.BuySellNo = buysell.BuySellNo

	left join GLAccount on WksDelivery.SalesGLAcct = glaccount.GLAcct

	left join CounterParty on buysell.CustID = counterparty.CpID

	left join CompanyInfo on buysell.COID = CompanyInfo.COID

where

	buysell.status = 'I'

	and ((InvoiceDt >=@FromDate) OR (@FromDate = ''))

	AND ((InvoiceDt <=@ToDate) OR (@ToDate = ''))

	and (buysell.CustID = @CustID or @CustID = '')

	AND (@CoID = '' OR (BuySell.CoID = @CoID))

	AND (@TradeType = '' OR @TradeType = BuySell.TradeType)

	AND (@salesRep = '' OR @salesRep= BuySell.ReferrerNo1 OR @salesRep= BuySell.ReferrerNo2)

	and (BuySell.CustID <> '(OTHER)' AND  BuySell.CustID <> '(INV)')

	and ChgToCustAmt <> 0

	AND (IsNull(IsAgency,0) <> 1)		--need to exclude for chargebacks





	--adjustmnets

INSERT

	#detail

SELECT 

	CounterParty.CompanyNm AS [company Name],

	buysell.CustID AS [Customer ID],

	'Adjustment: ' + isnull(GLAccount.Name,

	'Other') AS [adjustment TYPE],

	GPLedger.TradeDt,

	GPLedger.sale AS [total cost OF adjustment],

	buysell.BuySellNo,

	isnull(DBO.CONVERT_TO_UOM(AdjWeight,

	AdjWeightUOM,

	@UOM),

	0) ,

	0,

	CompanyInfo.CompanyDesc,

	CASE WHEN Buysell.custid = '(INV)' THEN 'R' WHEN buysell.vendorid='(INV)' THEN 'S' ELSE 'W' END

	,FORMAT(GPLedger.TradeDt, 'M/yyyy') TransactionPeriod

	--,CASE

	--	WHEN TRIM(CAST(MONTH(CAST(BuySell.InvoiceDt AS DATE)) AS VARCHAR)) = 1

	--  THEN '0' + CAST(MONTH(CAST(BuySell.InvoiceDt AS DATE)) AS VARCHAR)+ '/' + CAST(YEAR(CAST(BuySell.InvoiceDt AS DATE)) AS VARCHAR)

	--	ELSE CAST(MONTH(CAST(BuySell.InvoiceDt AS DATE)) AS VARCHAR)+ '/' + CAST(YEAR(CAST(BuySell.InvoiceDt AS DATE)) AS VARCHAR)

	--END TransactionPeriod

from BuySell

	left join CounterParty on buysell.CustID = CounterParty.CpID

	left join GPLedger on GPLedger.BuySellNo = buysell.BuySellNo

	left join GLAccount on  GPLedger.GLAcct = GLAccount.GLAcct

	left join CompanyInfo on buysell.COID = CompanyInfo.COID

where

	GPLedger.Source = 'A'

	AND GPLedger.AdjType = 'S'

	and GPLedger.AdjPosted = 'Y'

	AND (TradeDt >=@FromDate OR @FromDate = '')

	AND (TradeDt <=@ToDate OR @ToDate = '')

	and (buysell.CustID = @CustID or @CustID = '')

	AND (@CoID = '' OR (BuySell.CoID = @CoID))

	AND (@TradeType = '' OR @TradeType = BuySell.TradeType)

	AND (@salesRep = '' OR @salesRep= BuySell.ReferrerNo1 OR @salesRep= BuySell.ReferrerNo2)

	and GPLedger.sale <> 0

	and (BuySell.CustID <> '(OTHER)' AND  BuySell.CustID <> '(INV)')

END



IF @isdrilldown = 1 

BEGIN



   SELECT

	CompanyNm AS [Customer] ,

	shipppingDt AS [Shipping Date],

	buysellno AS [Wks NO] ,

	Grade AS [Product / Expense TYPE],

	Sales AS [Sale Amount]

	--[{C}Sale Amount]

	,

	TotalShippedWeight AS Tons

	--[Weight UOM] 

	,

	CAST(CASE

		WHEN TotalShippedWeight = 0 THEN 0.00

		ELSE (sales / TotalShippedWeight)

	END AS NUMERIC(22,

	3)) AS [Sale Per UOM],

	WksType AS '-Hidden-WksType'

FROM

	#detail

WHERE

	CompanyNm = @drilldownCust

END

ELSE

BEGIN

    SELECT BillCompany

	       ,CustomerID

		   ,[CustDescript]

		   ,CustGrade

		   ,[CieTrade Grade Name]

		   ,[AmountTotal]

		   , Delivery

		   ,TonsTotal

		   --, LbsTotal

		   ,FreightCharge

		   ,OtherChargesAvg

		   ,[Cust Adj Avg]

		   ,[FOB Price]

		   , CASE WHEN TonsTotal = 0 then 0

		     else [AmountTotal]/TonsTotal 

			 end PricePerTon

		   ,[Period]

		   ,SupplierID

		   ,[Net Revenue]

		   FROM(

	SELECT

	RTRIM(COID) AS BillCompany

	--Department

	,(SELECT Cpid FROM Counterparty where CompanyNm = #Detail.CompanyNm) CustomerID 

	,

	RTRIM(CompanyNm) + ' (' + (SELECT RTRIM(Cpid) FROM Counterparty where CompanyNm = #Detail.CompanyNm) +')' AS [CustDescript] --[Customer] ,

	--, (SELECT GradeID from Grade where [Description] = #Detail.Grade) GradeID

	, RTRIM(ISNULL((SELECT GradeID from Grade where [Description] = #Detail.Grade), '')) + ' ('  + RTRIM(Grade)  + ')' CustGrade

	, Grade AS [CieTrade Grade Name] --Grade

	--[Product/Expense Type]

	,

	sum(Sales) AS [AmountTotal]



	, '' Delivery

	,sum(TotalShippedWeight)/2000 AS [TonsTotal]

	,sum(TotalShippedWeight) AS [LbsTotal]

	, '' FreightCharge

	, '' OtherChargesAvg

	, '' [Cust Adj Avg]

	, '' [FOB Price]



	, case when sum(TotalShippedWeight) = 0 then 0

	       else ROUND(sum(Sales)/ sum(TotalShippedWeight), 2)

		   end PricePerTon



	--, '' PricePerTon



	,  TransactionPeriod [Period]

	, '' SupplierID

	, '' [Net Revenue]

	--[Weight UOM] 



	--[{C}Total Sales]

	,

	sum(shipmentcount) AS Loads, 

	CAST((CASE

		WHEN sum(TotalShippedWeight) > 0 THEN (sum(sales)/ sum(TotalShippedWeight))

		ELSE 0

	END) AS NUMERIC(22,

	3)) AS [Avg Sales]

	--[Avg Sales Per UOM] 

	--,WksType as '-Hidden-WksType'

	--,	TransactionPeriod [Period]



FROM

	#detail

GROUP BY

	COID,

	CompanyNm,

	Grade,

	WksType,

	TransactionPeriod) a1

	ORDER BY 1,3

--ORDER BY

	--COID,

	--CompanyNm,

	--Grade

	----asc

	--,TransactionPeriod



END

